<!-- templates/settings.html -->
{% extends "base.html" %}

{% block title %}Family Planner Settings{% endblock %}

{% block content %}
<h1>Family Planner Settings</h1>

<h2>Family Members</h2>
<ul id="family-members-list">
    {% for member in family_members %}
    <li id="member-{{ member.id }}">
        {{ member.name }}
        <button onclick="removeFamilyMember({{ member.id }}, '{{ member.name }}')">Remove</button>
    </li>
    {% endfor %}
</ul>

<div id="message" style="display: none;"></div>

<h3>Add New Family Member</h3>
<form action="{{ url_for('add_family_member') }}" method="post">
    <input type="text" name="name" required placeholder="Enter name">
    <button type="submit">Add Family Member</button>
</form>




<h3>Import/Export CSV</h3>
<form id="csv-form" action="{{ url_for('import_csv') }}" method="post" enctype="multipart/form-data">
    <select id="family-member-select" name="family_member_id" required>
        <option value="">Select Family Member</option>
        {% for member in family_members %}
        <option value="{{ member.id }}">{{ member.name }}</option>
        {% endfor %}
    </select>
    <input type="file" name="file" accept=".csv" required>
    <button type="submit">Import CSV</button>
    <button type="button" id="export-csv">Export CSV</button>
</form>

<a href="{{ url_for('index') }}">Back to Planner</a>

<script>
    function removeFamilyMember(memberId, memberName) {
        if (confirm(`Are you sure you want to remove ${memberName} and all associated entries? This action cannot be undone.`)) {
            fetch(`/remove_family_member/${memberId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                const messageDiv = document.getElementById('message');
                messageDiv.style.display = 'block';
                if (data.success) {
                    messageDiv.textContent = data.message;
                    messageDiv.style.color = 'green';
                    document.getElementById(`member-${memberId}`).remove();
                } else {
                    messageDiv.textContent = `Error: ${data.error}`;
                    messageDiv.style.color = 'red';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                const messageDiv = document.getElementById('message');
                messageDiv.style.display = 'block';
                messageDiv.textContent = 'An error occurred while removing the family member.';
                messageDiv.style.color = 'red';
            });
        }
    }
    document.getElementById('csv-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('{{ url_for("import_csv") }}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('CSV imported successfully!');
            } else {
                alert('Error importing CSV: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while importing the CSV.');
        });
    });

    document.getElementById('export-csv').addEventListener('click', function() {
        const familyMemberId = document.getElementById('family-member-select').value;
        if (!familyMemberId) {
            alert('Please select a family member to export data.');
            return;
        }
        
        window.location.href = `{{ url_for('export_csv') }}?family_member_id=${familyMemberId}`;
    });
</script>
{% endblock %}